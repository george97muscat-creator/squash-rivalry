<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Alex vs George</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f4f6f8; padding:20px; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
input, textarea { width: 70px; margin:3px; }
textarea { width: 100%; height:40px; }
button { padding:8px 12px; border-radius:8px; border:none; background:black; color:white; margin-top:5px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:6px; text-align:center; border-bottom:1px solid #eee; }
</style>
</head>
<body>

<h1>üèÜ Alex vs George</h1>

<div class="card">
<h2>Leaderboard</h2>
<table id="leaderboard"></table>
</div>

<div class="card">
<h2>Current Season</h2>
<div id="seasonScore"></div>
</div>

<div class="card">
<h2>Add Match</h2>
<div id="inputs"></div>
<button onclick="addMatch()">Add Match</button>
</div>

<div class="card">
<h2>Match History</h2>
<div id="history"></div>
</div>

<div class="card">
<h2>Charts</h2>
<canvas id="seasonChart"></canvas>
<br><br>
<canvas id="matchChart"></canvas>
</div>

<script type="module">

const firebaseConfig = {
  apiKey: "AIzaSyDfpeuk-5wI3bAAOh799W20ZjCNKj6G4Nc",
  authDomain: "squash-rivalry.firebaseapp.com",
  projectId: "squash-rivalry",
  storageBucket: "squash-rivalry.firebasestorage.app",
  messagingSenderId: "9288441167",
  appId: "1:9288441167:web:2bf24a4bfdbe7af385b93a"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data;

async function loadData(){
  const snap = await getDoc(doc(db,"squash","main"));
  if(snap.exists()){
    data = snap.data();
  } else {
    data = {
      players:["Alex","George"],
      seasons:[{matches:[],wins:[0,0],winner:null}]
    };
    await saveData();
  }
  renderAll();
}

async function saveData(){
  await setDoc(doc(db,"squash","main"),data);
}

function getCurrentSeason(){
  let s = data.seasons[data.seasons.length-1];
  if(s.winner!==null){
    s={matches:[],wins:[0,0],winner:null};
    data.seasons.push(s);
  }
  return s;
}

function calculateStats(){
  let stats=[
    {name:"Alex",seasons:0,matches:0,gamesWon:0,gamesLost:0,pointsDiff:0},
    {name:"George",seasons:0,matches:0,gamesWon:0,gamesLost:0,pointsDiff:0}
  ];
  data.seasons.forEach(s=>{
    if(s.winner!==null) stats[s.winner].seasons++;
    s.matches.forEach(m=>{
      stats[m.winner].matches++;
      m.games.forEach(g=>{
        stats[0].gamesWon += g[0]>g[1]?1:0;
        stats[1].gamesWon += g[1]>g[0]?1:0;
        stats[0].gamesLost += g[0]<g[1]?1:0;
        stats[1].gamesLost += g[1]<g[0]?1:0;
        stats[0].pointsDiff += g[0]-g[1];
        stats[1].pointsDiff += g[1]-g[0];
      });
    });
  });
  return stats.sort((a,b)=>b.seasons-a.seasons);
}

function renderAll(){
  renderLeaderboard();
  renderSeasonScore();
  renderHistory();
  renderCharts();
}

function renderLeaderboard(){
  let stats=calculateStats();
  let html="<tr><th>Player</th><th>Seasons</th><th>Matches</th><th>Games W</th><th>Games L</th><th>Points Diff</th></tr>";
  stats.forEach(p=>{
    html+=`<tr><td>${p.name}</td><td>${p.seasons}</td><td>${p.matches}</td><td>${p.gamesWon}</td><td>${p.gamesLost}</td><td>${p.pointsDiff}</td></tr>`;
  });
  document.getElementById("leaderboard").innerHTML=html;
}

function renderSeasonScore(){
  let s=getCurrentSeason();
  document.getElementById("seasonScore").innerText=
    "Alex "+s.wins[0]+" - "+s.wins[1]+" George";
}

function renderHistory(){
  let html="";
  data.seasons.forEach((s,i)=>{
    html+="<b>Season "+(i+1)+"</b><br>";
    s.matches.forEach((m,j)=>{
      let date = m.date || "N/A";
      let time = m.time || "N/A";
      let report = m.report || "";
      html+=`Match ${j+1} - Winner: ${data.players[m.winner]} | Date: ${date} ${time} | Games: ${m.games.map(g=>g.join("-")).join(", ")}<br>`;
      if(report) html+="&nbsp;&nbsp;Report: "+report+"<br>";
    });
    html+="<br>";
  });
  document.getElementById("history").innerHTML=html;
}

function renderCharts(){
  let stats=calculateStats();
  new Chart(document.getElementById("seasonChart"),{
    type:'bar',
    data:{labels:stats.map(p=>p.name),
    datasets:[{label:"Seasons Won",data:stats.map(p=>p.seasons)}]}
  });
  new Chart(document.getElementById("matchChart"),{
    type:'bar',
    data:{labels:stats.map(p=>p.name),
    datasets:[{label:"Matches Won",data:stats.map(p=>p.matches)}]}
  });
}

function createInputs(){
  let html="";
  for(let i=0;i<5;i++){
    html+=`Game ${i+1}: <input id="a${i}" type="number"> - <input id="b${i}" type="number"><br>`;
  }
  html+=`Date: <input type="date" id="matchDate"> Time: <input type="time" id="matchTime"><br>`;
  html+=`Match Report (optional):<br><textarea id="matchReport"></textarea><br>`;
  document.getElementById("inputs").innerHTML=html;
}

window.addMatch=async function(){
  let games=[];
  let wins=[0,0];
  for(let i=0;i<5;i++){
    let a=parseInt(document.getElementById("a"+i).value);
    let b=parseInt(document.getElementById("b"+i).value);
    if(!isNaN(a) && !isNaN(b)){
      // 2-clear points logic
      while(a>=14 && b>=14 && Math.abs(a-b)<2){
        if(a>b) a++; else b++;
      }
      games.push([a,b]);
      if(a>b) wins[0]++;
      if(b>a) wins[1]++;
    }
  }

  if(wins[0]===0 && wins[1]===0) return alert("Enter valid scores");

  let winner = wins[0] > wins[1] ? 0 : 1;
  let season = getCurrentSeason();
  let date = document.getElementById("matchDate").value;
  let time = document.getElementById("matchTime").value;
  let report = document.getElementById("matchReport").value;

  season.matches.push({
    games,
    winner,
    date,
    time,
    report
  });
  season.wins[winner]++;
  if(season.wins[winner]===5) season.winner = winner;

  await saveData();
  loadData();
}

createInputs();
loadData();

</script>
</body>
</html>
